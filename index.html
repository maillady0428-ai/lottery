<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#100d0a">
<title>MANULLER â€“ GACHA</title>
<style>
:root{
  --bg:#0a0907; --panel:#15110e; --edge:#2b2319;
  --gold:#d4af37; --gold2:#ffe27a; --txt:#f7f3e8; --muted:#b7a98a;
  --vio:#a974ff; --red:#ff6d8a; --green:#55f59a; --amber:#ffd166;
}
*{box-sizing:border-box}
body{margin:0;color:var(--txt);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;background:#0a0907}
.wrap{min-height:100svh;display:grid;place-items:center;padding:20px;
  background:
    radial-gradient(900px 480px at 80% -10%, rgba(212,175,55,.18), transparent 60%),
    radial-gradient(800px 440px at -10% 120%, rgba(169,116,255,.14), transparent 60%)}
.card{width:min(820px,96vw);background:linear-gradient(180deg,rgba(255,239,180,.05),rgba(0,0,0,.0)),var(--panel);
  border:1px solid var(--edge);border-radius:22px;padding:18px;box-shadow:0 12px 36px rgba(0,0,0,.55),inset 0 1px 0 rgba(255,235,185,.08)}
.title{display:flex;gap:12px;align-items:center;margin-bottom:8px}
.logo{width:46px;height:46px;border-radius:12px;background:conic-gradient(from 20deg,#5a441b,#e0c25a,#7a5c2b,#b7952b,#5a441b);box-shadow:inset 0 0 12px #0006,0 0 8px #d4af3744}
h1{margin:0;font-size:22px;letter-spacing:.02em}
.brand{background:linear-gradient(180deg,var(--gold2),var(--gold) 70%,#b9962a);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 1px 0 rgba(0,0,0,.4)}
.sub{color:var(--muted);font-size:13px}

/* ====== ã‚¬ãƒãƒ£æœ¬ä½“ ====== */
.machine{position:relative;border:1px solid #3a2d18;border-radius:18px;padding:16px;display:grid;grid-template-columns:1fr 92px;gap:12px;
  background:linear-gradient(180deg,#0f0c0a,#17130f);box-shadow:inset 0 0 18px rgba(0,0,0,.55)}

/* çª“ï¼ˆãƒ‰ãƒ©ãƒ ï¼‹ã‚«ãƒ—ã‚»ãƒ«ï¼‰ */
.window{height:196px;border-radius:16px;overflow:hidden;position:relative;background:linear-gradient(180deg,#0b0907,#110e0a);
  border:1px solid #4d3b21;box-shadow:inset 0 0 16px rgba(0,0,0,.85)}
/* ãƒ‰ãƒ©ãƒ ã®â€œç¸æ¨¡æ§˜â€ã§å›è»¢æ„Ÿã‚’å‡ºã™ */
.drumStripe{
  position:absolute; inset:0; opacity:.25; mix-blend-mode:screen; pointer-events:none;
  background:repeating-linear-gradient(90deg, #ffffff10 0 18px, #0000 18px 34px);
  transform:translateX(0);
}
@keyframes drum-move { from{transform:translateX(0)} to{transform:translateX(-50%)} }
@keyframes drum-move-fast { from{transform:translateX(0)} to{transform:translateX(-80%)} }
@keyframes drum-move-rev { from{transform:translateX(-50%)} to{transform:translateX(0)} }

/* æ¨ªãƒ™ãƒ«ãƒˆï¼ˆè¦‹ãˆã‚‹ã‚«ãƒ—ã‚»ãƒ«ãŒæµã‚Œã‚‹ï¼‰*/
.belt{position:absolute; left:0; top:50%; width:200%; transform:translateY(-50%); display:flex; gap:18px; padding-left:16px}
.ball{width:96px;height:96px;border-radius:50%;
  background:radial-gradient(circle at 34% 30%,#fff8,transparent 36%),linear-gradient(180deg,#8a2be2,#5a1ea8);
  box-shadow:inset 0 0 14px #000a,0 0 18px #6120ff44;border:2px solid #c9b0ff22}
.ball.red{background:radial-gradient(circle at 34% 30%,#fff8,transparent 36%),linear-gradient(180deg,#ff8aa4,#d74366)}
.ball.green{background:radial-gradient(circle at 34% 30%,#fff8,transparent 36%),linear-gradient(180deg,#66f59a,#18b35a)}
.ball.gold{background:radial-gradient(circle at 34% 30%,#fff8,transparent 36%),linear-gradient(180deg,#ffe27a,#d4af37);box-shadow:0 0 18px #ffd96655,inset 0 0 14px #000a}

/* æ’å‡ºå£ï¼ˆãƒ•ã‚¿ï¼‹ã‚«ãƒ—ã‚»ãƒ«ï¼‹å‰²ã‚Œã‚‹æ¼”å‡ºï¼‰ */
.tray{grid-column:1/2;margin-top:10px;height:110px;position:relative;display:flex;justify-content:center;align-items:flex-start}
.slot{width:320px;height:94px;border-radius:18px;background:linear-gradient(180deg,#0d0c0a,#19140f);border:1px solid #4d3b21;box-shadow:inset 0 0 16px rgba(0,0,0,.78);position:relative;overflow:hidden}
.lid{position:absolute;left:0;right:0;top:0;height:38px;background:linear-gradient(180deg,#221a10,#0c0a08);border-bottom:1px solid #634b24;transform-origin:top;transform:rotateX(0deg);transition:transform .26s ease}
.flash{position:absolute;inset:0;pointer-events:none;opacity:0;background:radial-gradient(240px 80px at 50% 55%,rgba(255,230,160,.35),transparent 60%);transition:opacity .14s ease}
.flash.on{opacity:1}

/* ã‚«ãƒ—ã‚»ãƒ«ãŒâ€œå‰²ã‚Œã¦â€ä¸­èº«ãŒç¾ã‚Œã‚‹ */
.capsWrap{position:absolute; left:50%; top:-110px; width:120px; height:120px; transform:translateX(-50%); opacity:0;
  transition:transform .56s ease, opacity .16s ease}
.capsWrap.show{opacity:1; transform:translate(-50%, 84px)}
.half{position:absolute; width:96px; height:48px; left:50%; transform:translateX(-50%); border-radius:48px 48px 0 0;
  background:radial-gradient(circle at 35% 30%,#fff8,transparent 36%), linear-gradient(180deg,#8a2be2,#5a1ea8); box-shadow:inset 0 0 12px #000a}
.half.bottom{top:48px; border-radius:0 0 48px 48px}
.capsWrap.gold .half{ background:radial-gradient(circle at 35% 30%,#fff8,transparent 36%), linear-gradient(180deg,#ffe27a,#d4af37) }
.capsWrap.green .half{ background:radial-gradient(circle at 35% 30%,#fff8,transparent 36%), linear-gradient(180deg,#66f59a,#18b35a) }
.capsWrap.red   .half{ background:radial-gradient(circle at 35% 30%,#fff8,transparent 36%), linear-gradient(180deg,#ff8aa4,#d74366) }

/* ã±ã‹ã£ */
.capsWrap.open .half.top{ animation:cap-open-top .28s ease forwards }
.capsWrap.open .half.bottom{ animation:cap-open-bottom .28s ease forwards }
@keyframes cap-open-top { to { transform:translateX(-120%) rotate(-18deg) } }
@keyframes cap-open-bottom { to { transform:translateX(20%) rotate(18deg) } }

/* ä¸­èº«ã‚«ãƒ¼ãƒ‰ */
.ticket{position:absolute; left:50%; top:34px; transform:translate(-50%,-8px) scale(.9); opacity:0;
  background:#111; color:#111; border-radius:10px; padding:8px 12px; font-weight:900; letter-spacing:.02em}
.capsWrap.show .ticket{opacity:1; transform:translate(-50%,0) scale(1)}
.t1{background:linear-gradient(180deg,#fff6cc,#ffd166); color:#5a4100; box-shadow:0 0 18px #ffd16655}
.t2{background:linear-gradient(180deg,#ffd6e3,#ff9bb6); color:#50121f}
.t3{background:linear-gradient(180deg,#e5d2ff,#bda0ff); color:#2a1552}
.t4{background:linear-gradient(180deg,#d4ffe4,#9cfabf); color:#134a2b}
.t5{background:linear-gradient(180deg,#e9eef5,#cbd6e6); color:#203244}

/* ãƒ¬ãƒãƒ¼ */
.leverWrap{grid-column:2/3;display:grid;place-items:center}
.leverBase{width:80px;height:170px;border-radius:14px;border:1px solid #3a2d18;background:linear-gradient(180deg,#120f0c,#19140f);box-shadow:inset 0 0 14px rgba(0,0,0,.6)}
.lever{width:18px;height:92px;background:#604a2b;border-radius:10px;margin:16px auto 0;position:relative;transform-origin:top center;transition:transform .16s ease}
.knob{width:42px;height:42px;border-radius:50%;background:radial-gradient(circle at 35% 30%,#fff8,transparent 36%),linear-gradient(180deg,#ffe27a,#d4af37);box-shadow:0 0 18px #ffd16655;position:absolute;left:50%;top:76px;transform:translateX(-50%)}

/* æ¼”å‡ºã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
.glow{position:absolute;inset:0;pointer-events:none;opacity:.0;transition:opacity .18s ease;background:
  radial-gradient(560px 160px at 50% 50%,rgba(255,220,120,.22),transparent 55%),
  radial-gradient(640px 200px at 50% 50%,rgba(169,116,255,.18),transparent 60%);mix-blend-mode:screen}
.glow.show{opacity:1}
.pillar{position:absolute;left:50%;top:14%;width:16px;height:250px;transform:translateX(-50%);display:none;border-radius:12px;z-index:2;
  background:linear-gradient(180deg,transparent,#ffe27a 35%,#fff 50%,#ffe27a 65%,transparent);box-shadow:0 0 36px #ffe27a,0 0 60px #ffd166}
.pillar.show{display:block}
.bolt{position:absolute;inset:0;display:none;z-index:2;background:
  repeating-linear-gradient(115deg,transparent 0 48px,rgba(255,255,255,.06) 48px 49px),
  radial-gradient(420px 140px at 50% 40%,rgba(255,225,150,.22),transparent 60%)}
.bolt::after{content:"";position:absolute;left:50%;top:8%;width:8px;height:140px;transform:translateX(-50%) rotate(6deg);
  background:linear-gradient(180deg,#fff,#ffd966 60%,transparent);filter:blur(1px);box-shadow:0 0 24px #ffd966aa,0 0 40px #ffd96666}
.bolt.show{display:block}

/* æƒ…å ±/ãƒœã‚¿ãƒ³ãƒ»ãƒãƒŠãƒ¼ */
.panel{margin-top:12px;padding:14px;border:1px solid #3a2d18;border-radius:14px;background:#100e0b}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{display:inline-block;cursor:pointer;user-select:none;padding:12px 18px;border-radius:12px;font-weight:800;letter-spacing:.02em;
  color:#100e0b;background:linear-gradient(180deg,var(--gold2),var(--gold));border:1px solid #b9962a;box-shadow:0 6px 16px rgba(212,175,55,.25),inset 0 1px 0 rgba(255,255,255,.35)}
.btn:active{transform:translateY(1px)}
.result{font-size:20px;line-height:1.7}
.muted{color:var(--muted)}
.banner{margin-top:10px;padding:14px;border-radius:14px;text-align:center;font-weight:900;letter-spacing:.02em;display:none}
.banner.show{display:block}
.b1{background:linear-gradient(180deg,#fff6cc,#ffd166);color:#5a4100}
.b2{background:linear-gradient(180deg,#ffd6e3,#ff9bb6);color:#50121f}
.b3{background:linear-gradient(180deg,#e5d2ff,#bda0ff);color:#2a1552}
.b4{background:linear-gradient(180deg,#d4ffe4,#9cfabf);color:#134a2b}
.b5{background:linear-gradient(180deg,#e9eef5,#cbd6e6);color:#203244}

/* STAFF / ãƒ¢ãƒ¼ãƒ€ãƒ« / ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
.staff{position:fixed;right:14px;bottom:14px;z-index:5;opacity:.9}
.staff .btn{padding:8px 10px}
.modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:10}
.modal.open{display:grid}
.dialog{width:min(420px,92vw);background:#111;border:1px solid #3a2d18;border-radius:14px;padding:16px 16px 18px}
.input{width:100%;font-size:18px;padding:10px 12px;border-radius:10px;border:1px solid #3a2d18;background:#0d0c0a;color:#fff}
.row2{display:flex;gap:8px;margin-top:10px;justify-content:flex-end}
.small{font-size:12px;color:#a8946a;margin-top:6px}
.overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:9}
.overlay.show{display:grid}
.spinner{width:24px;height:24px;border:3px solid #3e321a;border-top-color:var(--gold2);border-radius:50%;animation:spin .9s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="title">
      <div class="logo" id="logo"></div>
      <div>
        <h1 class="brand">MANULLER â€“ LOOSTER EDITION</h1>
        <div class="sub">1 PLAY 500å†† / STAFFè§£é™¤ â†’ START</div>
      </div>
    </div>

    <div class="machine">
      <!-- çª“ï¼šãƒ‰ãƒ©ãƒ ï¼‹ã‚«ãƒ—ã‚»ãƒ« -->
      <div class="window">
        <div class="glow" id="glow"></div>
        <div class="pillar" id="pillar"></div>
        <div class="bolt" id="bolt"></div>
        <div class="drumStripe" id="stripe"></div>
        <div class="belt" id="belt">
          <!-- ãŸãã•ã‚“æµã™ï¼ˆè¦–è¦šçš„ã«â€œå›è»¢ä¸­â€ã‚’ä½œã‚‹ï¼‰ -->
          <div class="ball"></div><div class="ball red"></div><div class="ball green"></div>
          <div class="ball"></div><div class="ball red"></div><div class="ball green"></div>
          <div class="ball"></div><div class="ball red"></div><div class="ball green"></div>
          <div class="ball"></div><div class="ball gold"></div>
          <div class="ball"></div><div class="ball red"></div><div class="ball green"></div>
          <div class="ball"></div><div class="ball red"></div><div class="ball green"></div>
        </div>
      </div>

      <!-- ãƒ¬ãƒãƒ¼ -->
      <div class="leverWrap">
        <div class="leverBase">
          <div class="lever" id="lever"><div class="knob"></div></div>
        </div>
      </div>

      <!-- æ’å‡ºå£ï¼ˆãƒ•ã‚¿â†’ã‚³ãƒ­ãƒ³â†’å‰²ã‚Œã‚‹ï¼‰ -->
      <div class="tray">
        <div class="slot" id="slot">
          <div class="lid" id="lid"></div>
          <div class="flash" id="flash"></div>

          <!-- å‰²ã‚Œã‚‹ã‚«ãƒ—ã‚»ãƒ« -->
          <div class="capsWrap" id="caps">
            <div class="half top"></div>
            <div class="half bottom"></div>
            <div id="ticket" class="ticket">çµæœ</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ãƒ­ãƒƒã‚¯/æŠ½é¸ -->
    <div class="panel" id="lockPanel">
      <div class="result">ğŸ”’ ç¾åœ¨ãƒ­ãƒƒã‚¯ä¸­ã€‚<br><span class="muted">åº—å“¡ã«è§£é™¤ã‚’ä¾é ¼ã—ã¦ãã ã•ã„ã€‚</span></div>
    </div>
    <div class="panel" id="drawPanel" style="display:none">
      <div id="status" class="result">æº–å‚™OKã€‚<span class="muted">ã€ŒSTARTã€ã§æŠ½é¸ã—ã¾ã™ã€‚</span></div>
      <div id="detail" class="muted"></div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="startBtn">START</button>
        <button class="btn" id="lockBtn" style="margin-left:auto;display:none">çµ‚äº†ã—ã¦ãƒ­ãƒƒã‚¯</button>
      </div>
      <div id="banner" class="banner"></div>
    </div>

    <div class="sub">æ™¯å“ï¼š1ç­‰ MOÃ‹Tã‚·ãƒ«ãƒãƒ¼ / 2ç­‰ ã‚«ãƒ•ã‚§ãƒ‘ãƒª / 3ç­‰ ç„¼é…ãƒœãƒˆãƒ« / 4ç­‰ ãƒ†ã‚­ãƒ¼ãƒ© or ãƒ‰ãƒªãƒ³ã‚¯1æ¯ç„¡æ–™ / 5ç­‰ ãŠã¤ã¾ã¿ã‚»ãƒƒãƒˆ</div>
  </div>
</div>

<!-- STAFF -->
<div class="staff"><button class="btn" id="staffBtn">STAFF</button></div>
<div class="modal" id="codeModal" aria-hidden="true">
  <div class="dialog">
    <h2>è§£é™¤ã‚³ãƒ¼ãƒ‰</h2>
    <input id="codeInput" class="input" type="password" placeholder="loo500" autocomplete="one-time-code">
    <div class="row2">
      <button class="btn" id="cancelBtn" type="button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn" id="unlockBtn" type="button">è§£é™¤</button>
    </div>
    <div class="small">è§£é™¤å¾Œã¯æŠ½é¸ã§ãã¾ã™ã€‚æŠ½é¸å¾Œã¯ã€Œçµ‚äº†ã—ã¦ãƒ­ãƒƒã‚¯ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
  </div>
</div>
<div class="overlay" id="overlay"><div class="spinner"></div></div>

<script>
/* ===== è¨­å®š ===== */
const GAS = "https://script.google.com/macros/s/AKfycbx2kXtpfhtmof_YWD5FEOJVvN03zdnD4yXNysO32DmNcTkXZSEJknF8Wn2mayqlUFFVgg/exec";
const STAFF_CODE = "loo500";

/* ===== è¦ç´  ===== */
const lockPanel=document.getElementById('lockPanel');
const drawPanel=document.getElementById('drawPanel');
const startBtn =document.getElementById('startBtn');
const lockBtn  =document.getElementById('lockBtn');
const statusEl =document.getElementById('status');
const detailEl =document.getElementById('detail');
const banner   =document.getElementById('banner');

const staffBtn =document.getElementById('staffBtn');
const codeModal=document.getElementById('codeModal');
const codeInput=document.getElementById('codeInput');
const cancelBtn=document.getElementById('cancelBtn');
const unlockBtn=document.getElementById('unlockBtn');
const logoEl   =document.getElementById('logo');

const belt   =document.getElementById('belt');
const stripe =document.getElementById('stripe');
const glow   =document.getElementById('glow');
const pillar =document.getElementById('pillar');
const bolt   =document.getElementById('bolt');
const lid    =document.getElementById('lid');
const flash  =document.getElementById('flash');
const caps   =document.getElementById('caps');
const ticket =document.getElementById('ticket');
const lever  =document.getElementById('lever');
const overlay=document.getElementById('overlay');

/* ===== ãƒ­ãƒƒã‚¯åˆ¶å¾¡ ===== */
function setLocked(lock=true){
  lockPanel.style.display=lock?'':'none';
  drawPanel.style.display=lock?'none':'';
  if(lock){
    startBtn.disabled=false; lockBtn.style.display='none';
    statusEl.textContent='æº–å‚™OKã€‚ã€ŒSTARTã€ã§æŠ½é¸ã—ã¾ã™ã€‚'; detailEl.textContent='';
    banner.className='banner'; banner.textContent='';
    resetScene();
  }
}
setLocked(true);

/* STAFFï¼ˆãƒœã‚¿ãƒ³ & ãƒ­ã‚´é•·æŠ¼ã—ï¼‰ */
staffBtn.addEventListener('click', openModal);
let t=null;
['touchstart','mousedown'].forEach(ev=>logoEl.addEventListener(ev,()=>t=setTimeout(openModal,800)));
['touchend','mouseup','mouseleave'].forEach(ev=>logoEl.addEventListener(ev,()=>clearTimeout(t)));
cancelBtn.addEventListener('click', closeModal);
unlockBtn.addEventListener('click', ()=>{
  if((codeInput.value||'').trim()===STAFF_CODE){ setLocked(false); closeModal(); } else { codeInput.value=''; codeInput.placeholder='ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™'; codeInput.focus(); }
});
function openModal(){ codeModal.classList.add('open'); codeInput.value=''; codeInput.focus(); }
function closeModal(){ codeModal.classList.remove('open'); }

/* ===== ãƒªã‚»ãƒƒãƒˆ ===== */
function resetScene(){
  belt.style.animation='none';
  stripe.style.animation='none';
  lever.style.transform='rotate(0deg)';
  glow.classList.remove('show'); pillar.classList.remove('show'); bolt.classList.remove('show');
  lid.style.transform='rotateX(0deg)'; flash.classList.remove('on');
  caps.className='capsWrap'; caps.style.opacity=0; caps.style.transform='translate(-50%,-110px)';
  ticket.className='ticket'; ticket.textContent='çµæœ';
}

/* ===== åŠ¹æœéŸ³ï¼ˆç°¡æ˜“WebAudioï¼‰ ===== */
let audioCtx=null;
function initAudio(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }
function beep({f=600,d=.1,t='square',g=.06}={}){ if(!audioCtx) return; const o=audioCtx.createOscillator(), v=audioCtx.createGain();
  o.type=t; o.frequency.value=f; v.gain.value=g; o.connect(v); v.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+d); }
const SE={
  lever:()=>{ beep({f:220,d:.07,t:'sawtooth',g:.08}); setTimeout(()=>beep({f:160,d:.06,t:'square',g:.06}),70); },
  spin :()=>{ if(!audioCtx) return; const o=audioCtx.createOscillator(), v=audioCtx.createGain(); o.type='triangle';
    o.frequency.setValueAtTime(95,audioCtx.currentTime); v.gain.setValueAtTime(0.016,audioCtx.currentTime);
    o.connect(v); v.connect(audioCtx.destination); o.start(); setTimeout(()=>{v.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.12); o.stop(audioCtx.currentTime+0.14);},360); },
  rev  :()=>{ beep({f:520,d:.06,t:'sawtooth',g:.06}); setTimeout(()=>beep({f:380,d:.08,t:'triangle',g:.05}),60); },
  pop  :()=>beep({f:660,d:.08,t:'square',g:.06}),
  fan2 :()=>{ beep({f:784,d:.12,t:'square',g:.07}); setTimeout(()=>beep({f:988,d:.18,t:'square',g:.07}),120); },
  fan1 :()=>{ beep({f:784,d:.12,t:'square',g:.08}); setTimeout(()=>beep({f:988,d:.14,t:'square',g:.08}),120); setTimeout(()=>beep({f:1175,d:.20,t:'square',g:.08}),260); }
};

/* ===== START ===== */
startBtn.addEventListener('click', draw);
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

async function draw(){
  startBtn.disabled=true; lockBtn.style.display='none';
  initAudio();
  // ãƒ¬ãƒãƒ¼
  lever.style.transform='rotate(28deg)'; SE.lever(); setTimeout(()=>lever.style.transform='rotate(0deg)',160);

  // å›è»¢é–‹å§‹ï¼ˆãƒ™ãƒ«ãƒˆï¼‹ç¸æ¨¡æ§˜ï¼‰
  resetScene(); glow.classList.add('show');
  belt.style.animation='drum-move 1.2s linear infinite';
  stripe.style.animation='drum-move 1.2s linear infinite';
  SE.spin();

  // æŠ½é¸
  overlay.classList.add('show');
  let data=null; try{
    const res=await fetch(GAS+'?ua='+encodeURIComponent(navigator.userAgent),{cache:'no-store'});
    data=await res.json();
  }catch(e){}
  overlay.classList.remove('show');

  if(!data || !data.status){
    statusEl.textContent='é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
    startBtn.disabled=false; return;
  }
  if(data.status==='ok'){ await playByPrize(data.prize); showResult(data.prize); return; }

  // ä¸‡ä¸€already â†’ 5ç­‰æ¼”å‡º
  await playByPrize('P5'); statusEl.textContent='ï¼ˆå‚è€ƒï¼‰ä»¥å‰ã®åˆ¶é™ãƒ¢ãƒ¼ãƒ‰ã®å¿œç­”ï¼šalready'; lockBtn.style.display='inline-block'; startBtn.disabled=false;
}

/* ===== ç­‰ç´šåˆ¥ã®æ¼”å‡ºï¼ˆã‚¬ãƒãƒ£ç‰ˆï¼‰ ===== */
async function playByPrize(p){
  if(p==='P1'){ // é‡‘å…‰æŸ±ï¼‹ç´™å¹é›ªMAX
    belt.style.animation='drum-move-fast .95s linear infinite';
    stripe.style.animation='drum-move-fast .95s linear infinite';
    await sleep(520); pillar.classList.add('show'); await sleep(220); bolt.classList.add('show'); await sleep(160);
    await dispense('gold'); SE.fan1(); confettiMax();
  }else if(p==='P2'){ // ç¨²å¦»ï¼‹åŠ é€Ÿ â†’ æ’å‡º
    bolt.classList.add('show');
    belt.style.animation='drum-move-fast .9s linear infinite';
    stripe.style.animation='drum-move-fast .9s linear infinite';
    await sleep(620); await dispense('red'); SE.fan2(); confettiMid();
  }else if(p==='P3'){ // é€†èµ°ãƒãƒ©ï¼ˆçŸ­ãï¼‰â†’ æ’å‡º
    await sleep(700);
    SE.rev();
    belt.style.animation='drum-move-rev .12s linear 1'; stripe.style.animation='drum-move-rev .12s linear 1';
    await sleep(140);
    belt.style.animation='drum-move 1.18s linear infinite'; stripe.style.animation='drum-move 1.18s linear infinite';
    await sleep(220); await dispense(''); SE.pop(); confettiLite();
  }else if(p==='P4'){ // ãµã¤ã†ï¼‹å°‘ã—å…‰
    await sleep(680); await dispense('green'); SE.pop();
  }else{ // P5
    await sleep(640); await dispense(''); SE.pop();
  }
}

async function dispense(color=''){
  // ãƒ•ã‚¿é–‹ â†’ ã‚«ãƒ—ã‚»ãƒ«å‡ºã‚‹ï¼ˆè¡¨ç¤ºï¼‰â†’ ãƒãƒ³ â†’ å‰²ã‚Œã¦ä¸­èº«
  lid.style.transform='rotateX(88deg)';
  flash.classList.add('on'); setTimeout(()=>flash.classList.remove('on'),140);

  // è‰²
  caps.className='capsWrap' + (color==='gold'?' gold':color==='green'?' green':color==='red'?' red':'');
  // å‡ºã™
  caps.style.opacity=0; caps.style.transform='translate(-50%,-110px)';
  await sleep(60);
  caps.classList.add('show');
  await sleep(460);
  flash.classList.add('on'); setTimeout(()=>flash.classList.remove('on'),140);
  // â€œã±ã‹ã£â€
  caps.classList.add('open');

  // ãƒ•ã‚¿æˆ»ã™
  setTimeout(()=>lid.style.transform='rotateX(0deg)',160);
}

/* ç´™å¹é›ª */
function confettiLite(){ confetti({particleCount:120, spread:70, origin:{y:0.3}}) }
function confettiMid(){ confetti({particleCount:200, spread:75, origin:{y:0.3}}) }
function confettiMax(){
  confetti({particleCount:320, spread:80, startVelocity:55, ticks:200, origin:{y:0.3}, colors:['#fff6cc','#ffe082','#ffd54f','#d4af37']});
  setTimeout(()=>confetti({particleCount:200, spread:70, origin:{y:0.3}}),160);
}

/* çµæœè¡¨ç¤ºï¼ˆå½“ãŸã‚Šã‚«ãƒ¼ãƒ‰ï¼‹ãƒãƒŠãƒ¼ï¼‰ */
function showResult(p){
  const label={P1:'ğŸ‰ å¤§å½“ãŸã‚Šï¼1ç­‰',P2:'âœ¨ 2ç­‰ å½“ãŸã‚Šï¼',P3:'ğŸ˜Š 3ç­‰',P4:'ğŸ‘ 4ç­‰',P5:'ğŸ™‚ 5ç­‰'}[p]||'çµæœ';
  const prize={P1:'MOÃ‹Tã‚·ãƒ«ãƒãƒ¼',P2:'ã‚«ãƒ•ã‚§ãƒ‘ãƒª',P3:'ç„¼é…ãƒœãƒˆãƒ«',P4:'ãƒ†ã‚­ãƒ¼ãƒ© or ãƒ‰ãƒªãƒ³ã‚¯1æ¯ç„¡æ–™',P5:'ãŠã¤ã¾ã¿ã‚»ãƒƒãƒˆ'}[p]||'';
  statusEl.textContent=label; detailEl.textContent=prize;

  // ã‚«ãƒ¼ãƒ‰ã®è‰²
  ticket.className='ticket ' + (p==='P1'?'t1':p==='P2'?'t2':p==='P3'?'t3':p==='P4'?'t4':'t5');
  ticket.textContent=`${label} â€“ ${prize}`;

  // ä¸‹ã®ãƒãƒŠãƒ¼ã‚‚å‡ºã™
  banner.className='banner show ' + (p==='P1'?'b1':p==='P2'?'b2':p==='P3'?'b3':p==='P4'?'b4':'b5');
  banner.textContent = `${label}  â€“  ${prize}`;

  lockBtn.style.display='inline-block';
  startBtn.disabled=false;
}

/* çµ‚äº†ã—ã¦ãƒ­ãƒƒã‚¯ */
lockBtn.addEventListener('click', ()=> setLocked(true));
</script>
</body>
</html>
