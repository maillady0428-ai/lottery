<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>LOOSTER GACHA – THE GAME OF DESTINY</title>
<meta name="theme-color" content="#0a0a0a">
<style>
:root{
  --bg:#0a0a0a;
  --panel:#0f0f0f;
  --edge:#2a2316;
  --gold:#d7c48a;         /* シャンパンゴールド */
  --gold-hi:#f6e7ad;
  --gold-deep:#b89b4e;
  --txt:#f4f2ec;
  --muted:#a89a7c;
  --green:#3ee3a4;
  --red:#ff6e8b;
  --vio:#a78bff;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%}
body{
  background:
    radial-gradient(1200px 520px at 75% -10%,#d7c48a18,transparent 60%),
    radial-gradient(1000px 600px at -15% 120%,#a78bff14,transparent 60%),
    var(--bg);
  color:var(--txt);
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
}

/* ====== レイアウト ====== */
.wrap{min-height:100%;display:grid;place-items:center;padding:20px}
.shell{
  width:min(880px,96vw);
  background:linear-gradient(180deg,#151515,#0d0d0d);
  border:1px solid var(--edge);
  border-radius:20px;
  box-shadow:
    0 18px 50px rgba(0,0,0,.6),
    inset 0 1px 0 rgba(255,255,255,.06);
  padding:16px 16px 18px;
  position:relative;
  overflow:hidden;
}

/* ====== ヘッダー ====== */
.top{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  margin-bottom:8px;
}
.brand{
  margin:0; letter-spacing:.06em; font-weight:900; font-size:21px;
  background:linear-gradient(180deg,var(--gold-hi),var(--gold) 62%,var(--gold-deep));
  -webkit-background-clip:text; background-clip:text; color:transparent;
  text-shadow:0 1px 0 rgba(0,0,0,.45);
}
.tag{color:var(--muted); font-size:12px}

/* ====== ガチャ筐体（黒金・実在風） ====== */
.machine{
  border:1px solid var(--edge); border-radius:16px; padding:16px;
  background:linear-gradient(180deg,#101010,#121212);
  box-shadow:inset 0 0 22px rgba(0,0,0,.65);
  display:grid; grid-template-columns:1fr 110px; gap:14px;
}
/* 上部発光パネル */
.headerPanel{
  grid-column:1/-1;
  height:56px; border-radius:12px;
  background:
    radial-gradient(220px 70px at 25% 50%, #fff3, transparent 60%),
    linear-gradient(180deg,#1b1b1b,#0b0b0b);
  border:1px solid var(--edge);
  display:flex; align-items:center; justify-content:center; gap:10px;
  position:relative; overflow:hidden;
}
.headerPanel::before{
  content:""; position:absolute; inset:0; pointer-events:none; opacity:.65;
  background:
    radial-gradient(800px 120px at 50% 0%, #f6e7ad22, transparent 40%),
    radial-gradient(700px 140px at 50% 100%, #a78bff11, transparent 42%);
  mix-blend-mode:screen;
}
.panelTitle{
  font-weight:900; letter-spacing:.22em; font-size:14px;
  color:#0b0b0b; padding:6px 12px; border-radius:8px;
  background:linear-gradient(180deg,var(--gold-hi),var(--gold) 70%,var(--gold-deep));
  border:1px solid var(--gold-deep);
  box-shadow:0 0 24px #f6e7ad33, inset 0 1px 0 #fff9;
}
.panelSub{color:var(--muted); font-size:12px}

/* 覗き窓（内部ドラム） */
.window{
  height:220px; position:relative; border-radius:14px; overflow:hidden;
  background:linear-gradient(180deg,#070707,#111);
  border:1px solid var(--edge);
  box-shadow:inset 0 0 16px rgba(0,0,0,.8);
}
.drumShade{position:absolute; inset:0; background:
  repeating-linear-gradient(90deg, #ffffff10 0 26px, #0000 26px 42px);
  opacity:.22; mix-blend-mode:screen; transform:translateX(0);
}
@keyframes stripe-move { from{transform:translateX(0)} to{transform:translateX(-50%)} }
@keyframes stripe-fast { from{transform:translateX(0)} to{transform:translateX(-80%)} }
@keyframes stripe-rev  { from{transform:translateX(-50%)} to{transform:translateX(0)} }

/* 内部を流れるカプセル（見た目） */
.belt{position:absolute; left:0; top:50%; transform:translateY(-50%); width:220%; display:flex; gap:18px; padding-left:18px}
.cBall{
  width:96px; height:96px; border-radius:50%;
  background:
    radial-gradient(circle at 32% 30%, #fff8, transparent 36%),
    linear-gradient(180deg,#4a4a4a,#1f1f1f);
  border:2px solid #ffffff1c;
  box-shadow:inset 0 0 12px #000a, 0 0 18px #ffffff24;
}
.cBall.gold{background:
  radial-gradient(circle at 32% 30%, #fff8, transparent 36%),
  linear-gradient(180deg,var(--gold-hi),var(--gold));
  border-color:#fff3; box-shadow:0 0 20px #f6e7ad44, inset 0 0 12px #000a}
.cBall.green{background:
  radial-gradient(circle at 32% 30%, #fff8, transparent 36%),
  linear-gradient(180deg,#64ffb7,#1abc74)}
.cBall.red{background:
  radial-gradient(circle at 32% 30%, #fff8, transparent 36%),
  linear-gradient(180deg,#ff98ae,#d94e72)}

/* 排出口 */
.tray{position:relative; height:120px; grid-column:1/2; display:flex; justify-content:center; align-items:flex-start; margin-top:6px}
.chute{
  width:360px; height:100px; border-radius:18px;
  background:linear-gradient(180deg,#0c0c0c,#151515);
  border:1px solid var(--edge);
  box-shadow:inset 0 0 16px rgba(0,0,0,.78);
  position:relative; overflow:hidden;
}
.lid{
  position:absolute; left:0; right:0; top:0; height:42px;
  background:linear-gradient(180deg,#262018,#0e0d0b);
  border-bottom:1px solid var(--edge);
  transform-origin:top; transform:rotateX(0deg);
  transition:transform .24s ease;
}
.flash{position:absolute; inset:0; background:
  radial-gradient(240px 80px at 50% 55%, #f6e7ad33, transparent 60%);
  opacity:0; transition:opacity .14s ease}
.flash.on{opacity:1}

/* 出てくる“実カプセル” */
.capWrap{position:absolute; left:50%; top:-120px; transform:translateX(-50%); width:130px; height:130px; opacity:0}
.capWrap.show{animation:cap-drop .55s ease forwards}
@keyframes cap-drop{
  0%{transform:translate(-50%,-90px) scale(.9); opacity:0}
  80%{transform:translate(-50%,68px)  scale(1);   opacity:1}
  100%{transform:translate(-50%,74px)  scale(1);   opacity:1}
}
.cap{position:absolute; inset:0; border-radius:50%;
  background:radial-gradient(circle at 35% 30%,#fff8,transparent 36%), linear-gradient(180deg,#575757,#1c1c1c);
  border:2px solid #ffffff22; box-shadow:inset 0 0 12px #000a}
.cap.gold{background:radial-gradient(circle at 35% 30%,#fff8,transparent 36%), linear-gradient(180deg,var(--gold-hi),var(--gold))}
.cap.green{background:radial-gradient(circle at 35% 30%,#fff8,transparent 36%), linear-gradient(180deg,#64ffb7,#11b66d)}
.cap.red{background:radial-gradient(circle at 35% 30%,#fff8,transparent 36%), linear-gradient(180deg,#ff9fba,#d94e72)}
.capTop{clip-path:inset(0 0 50% 0); transform-origin:50% 46%}
.capBot{clip-path:inset(50% 0 0 0); transform-origin:50% 54%}
.open .capTop{animation:cap-top .26s ease forwards}
.open .capBot{animation:cap-bot .26s ease forwards}
@keyframes cap-top{to{transform:translate(-12%, -20%) rotate(-18deg)}}
@keyframes cap-bot{to{transform:translate( 12%,  20%) rotate( 18deg)}}

/* 賞カード（カプセルから現れる） */
.ticket{
  position:absolute; left:50%; top:40px; transform:translate(-50%,0) scale(.9); opacity:0;
  padding:10px 14px; font-weight:900; letter-spacing:.02em; border-radius:10px; color:#111;
  box-shadow:0 0 12px #000a, 0 14px 34px #0008;
}
.capWrap.show .ticket{animation:card-in .28s ease .26s forwards}
@keyframes card-in{to{opacity:1; transform:translate(-50%,-2px) scale(1)}}
.t1{background:linear-gradient(180deg,var(--gold-hi),var(--gold));  border:1px solid var(--gold-deep)}
.t2{background:linear-gradient(180deg,#ffd6e4,#ff9fb9);          border:1px solid #a33a5b}
.t3{background:linear-gradient(180deg,#e7d8ff,#b9a3ff);          border:1px solid #6649c2}
.t4{background:linear-gradient(180deg,#d8ffe9,#9bf4c6);          border:1px solid #1c7a53}
.t5{background:linear-gradient(180deg,#e9eef6,#cbd6e6);          border:1px solid #394b66}

/* レバー（ヘビーデューティ） */
.leverBox{grid-column:2/3; display:grid; place-items:center}
.leverBase{
  width:96px; height:210px; border-radius:14px;
  background:linear-gradient(180deg,#0c0c0c,#1a1a1a); border:1px solid var(--edge);
  box-shadow:inset 0 0 14px rgba(0,0,0,.6);
  position:relative;
}
.arm{width:18px; height:120px; background:#6b4d21; border-radius:10px; margin:18px auto 0;
  transform-origin:top center; transition:transform .16s ease}
.knob{position:absolute; left:50%; top:94px; transform:translateX(-50%);
  width:48px; height:48px; border-radius:50%;
  background:radial-gradient(circle at 35% 30%,#fff8,transparent 36%), linear-gradient(180deg,var(--gold-hi),var(--gold));
  border:1px solid var(--gold-deep); box-shadow:0 0 22px #f6e7ad55}

/* 金光柱・稲妻（演出） */
.glow{position:absolute; inset:0; pointer-events:none; opacity:0; transition:opacity .18s ease; mix-blend-mode:screen}
.glow.on{opacity:1; background:
  radial-gradient(600px 200px at 50% 45%, #f6e7ad22, transparent 60%),
  radial-gradient(640px 220px at 50% 60%, #a78bff1c, transparent 60%)}
.pillar{position:absolute; left:50%; top:20px; width:18px; height:260px; transform:translateX(-50%); display:none; z-index:2;
  background:linear-gradient(180deg,transparent,var(--gold-hi) 40%, #fff 50%, var(--gold-hi) 60%, transparent);
  box-shadow:0 0 36px var(--gold-hi), 0 0 60px var(--gold);
}
.pillar.show{display:block}
.bolt{position:absolute; inset:0; display:none; z-index:2; background:
  repeating-linear-gradient(115deg, transparent 0 48px, rgba(255,255,255,.06) 48px 49px),
  radial-gradient(420px 140px at 50% 40%, rgba(255,255,255,.18), transparent 60%)}
.bolt.show{display:block}

/* 情報パネル */
.panel{margin-top:12px; padding:14px; border:1px solid var(--edge); border-radius:14px; background:var(--panel)}
.row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.btn{
  border:1px solid var(--gold-deep); color:#0b0b0b; font-weight:900; letter-spacing:.02em;
  padding:12px 18px; border-radius:12px; cursor:pointer; user-select:none;
  background:linear-gradient(180deg,var(--gold-hi),var(--gold));
  box-shadow:0 6px 16px #f6e7ad33, inset 0 1px 0 #fff9;
}
.btn:active{transform:translateY(1px)}
.ghost{background:#141414; color:var(--txt); border:1px solid var(--edge)}
.result{font-size:18px}
.muted{color:var(--muted)}

/* フルスクリーン結果カード */
.resultLayer{position:fixed; inset:0; display:none; place-items:center; background:#0008; z-index:50}
.rcard{
  width:min(640px,92vw); border-radius:16px; padding:20px; text-align:center; font-weight:900;
  border:1px solid var(--edge); box-shadow:0 22px 60px #0009
}
.r1{background:linear-gradient(180deg,var(--gold-hi),var(--gold)); color:#3a2e0f}
.r2{background:linear-gradient(180deg,#ffd6ea,#ff9cc0); color:#4a1230}
.r3{background:linear-gradient(180deg,#e7d8ff,#bfa2ff); color:#27144f}
.r4{background:linear-gradient(180deg,#d8ffe9,#a5f4d1); color:#0d4a2b}
.r5{background:linear-gradient(180deg,#ecf0f7,#cbd6e6); color:#1a2c5a}
.rt{font-size:28px;margin:0 0 6px}
.rp{font-size:18px;margin:0 0 12px;opacity:.9}

/* STAFF & モーダル & ローディング */
.staff{position:fixed;right:14px;bottom:14px;z-index:60}
.modal{position:fixed;inset:0;display:none;place-items:center;background:#0009;z-index:70}
.modal.open{display:grid}
.dialog{width:min(420px,92vw);background:#111;border:1px solid var(--edge);border-radius:14px;padding:16px}
.input{width:100%;font-size:18px;padding:10px 12px;border-radius:10px;border:1px solid var(--edge);background:#0c0c0c;color:#fff}
.rowR{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.overlay{position:fixed;inset:0;display:none;place-items:center;background:#0006;z-index:40}
.overlay.show{display:grid}
.spinner{width:26px;height:26px;border:3px solid #2a2a2a;border-top-color:var(--gold-hi);border-radius:50%;animation:spin .9s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="shell">

    <div class="top">
      <div>
        <h1 class="brand">LOOSTER GACHA</h1>
        <div class="tag">THE GAME OF DESTINY ・ 1 PLAY 500円</div>
      </div>
      <button id="lockBtn" class="btn ghost" style="display:none">終了してロック</button>
    </div>

    <div class="machine">
      <div class="headerPanel">
        <div class="panelTitle">LOOSTER GACHA</div>
        <div class="panelSub">THE GAME OF DESTINY</div>
      </div>

      <!-- 覗き窓 -->
      <div class="window">
        <div id="glow" class="glow"></div>
        <div id="pillar" class="pillar"></div>
        <div id="bolt" class="bolt"></div>
        <div id="drumShade" class="drumShade"></div>
        <div id="belt" class="belt">
          <!-- 見えるカプセル群 -->
          <div class="cBall"></div><div class="cBall red"></div><div class="cBall green"></div>
          <div class="cBall"></div><div class="cBall red"></div><div class="cBall green"></div>
          <div class="cBall"></div><div class="cBall gold"></div>
          <div class="cBall"></div><div class="cBall red"></div><div class="cBall green"></div>
          <div class="cBall"></div><div class="cBall red"></div><div class="cBall green"></div>
        </div>
      </div>

      <!-- レバー -->
      <div class="leverBox">
        <div class="leverBase">
          <div id="arm" class="arm"></div>
          <div class="knob"></div>
        </div>
      </div>

      <!-- 排出口 -->
      <div class="tray">
        <div class="chute">
          <div id="lid" class="lid"></div>
          <div id="flash" class="flash"></div>

          <!-- 実カプセル（落下→開封→賞） -->
          <div id="capWrap" class="capWrap">
            <div id="capTop" class="cap capTop"></div>
            <div id="capBot" class="cap capBot"></div>
            <div id="ticket" class="ticket">RESULT</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ロック/抽選 -->
    <div id="lockPanel" class="panel">
      <div class="result">🔒 ロック中。<span class="muted">店員に解除を依頼してください。</span></div>
    </div>
    <div id="drawPanel" class="panel" style="display:none">
      <div id="status" class="result">READY</div>
      <div id="detail" class="muted">「START」で抽選します。</div>
      <div class="row" style="margin-top:10px">
        <button id="startBtn" class="btn">START</button>
      </div>
    </div>

    <div class="tag" style="margin-top:10px">
      景品：1等 MOËTシルバー / 2等 カフェパリ / 3等 焼酎ボトル / 4等 ドリンク1杯 or テキーラ / 5等 おつまみセット
    </div>
  </div>
</div>

<!-- フルスクリーン結果 -->
<div id="resultLayer" class="resultLayer" aria-hidden="true">
  <div id="rcard" class="rcard r5">
    <h2 id="rt" class="rt">5等</h2>
    <p id="rp" class="rp">おつまみセット</p>
    <div class="row">
      <button id="okBtn" class="btn">OK</button>
    </div>
    <div class="tag" style="margin-top:8px">スタッフの操作で「終了してロック」を押してください。</div>
  </div>
</div>

<!-- STAFF -->
<div class="staff"><button id="staffBtn" class="btn">STAFF</button></div>
<div id="codeModal" class="modal">
  <div class="dialog">
    <h3 style="margin:0 0 10px">解除コード</h3>
    <input id="codeInput" class="input" type="password" placeholder="loo500">
    <div class="rowR">
      <button id="cancelBtn" class="btn ghost">キャンセル</button>
      <button id="unlockBtn" class="btn">解除</button>
    </div>
  </div>
</div>

<div id="overlay" class="overlay"><div class="spinner"></div></div>

<script>
/* ===== 設定 ===== */
const GAS = "https://script.google.com/macros/s/AKfycbx2kXtpfhtmof_YWD5FEOJVvN03zdnD4yXNysO32DmNcTkXZSEJknF8Wn2mayqlUFFVgg/exec";
const STAFF_CODE = "loo500";

/* ===== 要素 ===== */
const lockPanel=document.getElementById('lockPanel');
const drawPanel=document.getElementById('drawPanel');
const startBtn=document.getElementById('startBtn');
const lockBtn=document.getElementById('lockBtn');
const statusEl=document.getElementById('status');
const detailEl=document.getElementById('detail');

const belt=document.getElementById('belt');
const drumShade=document.getElementById('drumShade');
const glow=document.getElementById('glow');
const pillar=document.getElementById('pillar');
const bolt=document.getElementById('bolt');
const arm=document.getElementById('arm');

const lid=document.getElementById('lid');
const flash=document.getElementById('flash');
const capWrap=document.getElementById('capWrap');
const capTop=document.getElementById('capTop');
const capBot=document.getElementById('capBot');
const ticket=document.getElementById('ticket');

const resultLayer=document.getElementById('resultLayer');
const rcard=document.getElementById('rcard');
const rt=document.getElementById('rt');
const rp=document.getElementById('rp');
const okBtn=document.getElementById('okBtn');

const staffBtn=document.getElementById('staffBtn');
const codeModal=document.getElementById('codeModal');
const codeInput=document.getElementById('codeInput');
const cancelBtn=document.getElementById('cancelBtn');
const unlockBtn=document.getElementById('unlockBtn');

const overlay=document.getElementById('overlay');

/* ===== ロック制御 ===== */
function setLocked(lock=true){
  lockPanel.style.display=lock?'':'none';
  drawPanel.style.display=lock?'none':'';
  lockBtn.style.display=lock?'none':'inline-block';
  if(lock){ resetScene(); startBtn.disabled=false; statusEl.textContent='READY'; detailEl.textContent='「START」で抽選します。'; }
}
setLocked(true);

/* STAFF */
function openCode(){ codeModal.classList.add('open'); codeInput.value=''; codeInput.focus(); }
function closeCode(){ codeModal.classList.remove('open'); }
staffBtn.addEventListener('click', openCode);
cancelBtn.addEventListener('click', closeCode);
unlockBtn.addEventListener('click', ()=>{
  if((codeInput.value||'').trim()===STAFF_CODE){ setLocked(false); closeCode(); }
  else{ codeInput.value=''; codeInput.placeholder='コードが違います'; codeInput.focus(); }
});

/* ===== 効果音（簡易WebAudio） ===== */
let ctx=null;
function audio(){ if(!ctx) ctx=new (window.AudioContext||window.webkitAudioContext)(); }
function tone(f,d=.10,t='square',g=.06){ if(!ctx) return; const o=ctx.createOscillator(), v=ctx.createGain(); o.type=t; o.frequency.value=f; v.gain.value=g; o.connect(v); v.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+d); }
const SE={
  lever:()=>{ tone(220,.07,'sawtooth',.08); setTimeout(()=>tone(160,.06,'square',.06),70) },
  spin :()=>{ if(!ctx) return; const o=ctx.createOscillator(), v=ctx.createGain(); o.type='triangle'; o.frequency.setValueAtTime(90,ctx.currentTime); v.gain.setValueAtTime(.016,ctx.currentTime); o.connect(v); v.connect(ctx.destination); o.start(); setTimeout(()=>{v.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+.12); o.stop(ctx.currentTime+.14)},360) },
  rev  :()=>{ tone(520,.06,'sawtooth',.06); setTimeout(()=>tone(380,.08,'triangle',.05),60) },
  fan2 :()=>{ tone(784,.12); setTimeout(()=>tone(988,.18),120) },
  fan1 :()=>{ tone(784,.12); setTimeout(()=>tone(988,.14),120); setTimeout(()=>tone(1175,.20),260) },
  pop  :()=> tone(760,.08,'square',.06)
};

/* ===== ユーティリティ ===== */
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function resetScene(){
  // 窓
  belt.style.animation='none'; drumShade.style.animation='none'; glow.classList.remove('on'); pillar.classList.remove('show'); bolt.classList.remove('show');
  // レバー
  arm.style.transform='rotate(0deg)';
  // 排出口
  lid.style.transform='rotateX(0deg)'; flash.classList.remove('on');
  capWrap.className='capWrap'; capWrap.style.opacity=0; ticket.className='ticket'; ticket.textContent='RESULT';
}

/* ===== START ===== */
startBtn.addEventListener('click', draw);
lockBtn.addEventListener('click', ()=> setLocked(true));
okBtn.addEventListener('click', ()=> resultLayer.style.display='none');

async function draw(){
  startBtn.disabled=true; audio();

  // レバーを倒す
  arm.style.transform='rotate(30deg)'; SE.lever(); setTimeout(()=>arm.style.transform='rotate(0deg)',170);

  // ドラム回転開始（見た目）
  glow.classList.add('on');
  belt.style.animation='stripe-move 1.2s linear infinite';
  drumShade.style.animation='stripe-move 1.2s linear infinite';
  SE.spin();

  // GAS 抽選
  overlay.classList.add('show');
  let data=null;
  try{
    const res = await fetch(GAS+'?ua='+encodeURIComponent(navigator.userAgent), {cache:'no-store'});
    data = await res.json();
  }catch(e){}
  overlay.classList.remove('show');

  if(!data || !data.status){ statusEl.textContent='通信エラー。もう一度お試しください。'; startBtn.disabled=false; return; }

  // 等級別演出
  if(data.status==='ok'){ await playByPrize(data.prize); showResult(data.prize); }
  else { await playByPrize('P5'); showResult('P5'); } // フォールバック

  startBtn.disabled=false;
}

/* ===== 等級別の演出（黒金版） ===== */
async function playByPrize(p){
  // 1/2/3等は差を大きく
  if(p==='P1'){            // 金光柱→稲妻→超開封
    belt.style.animation='stripe-fast .95s linear infinite';
    drumShade.style.animation='stripe-fast .95s linear infinite';
    await sleep(480);
    pillar.classList.add('show'); await sleep(180);
    bolt.classList.add('show'); await sleep(160);
    await dispense('gold'); SE.fan1(); confettiMax();
  }else if(p==='P2'){      // 稲妻＋ブースト
    bolt.classList.add('show');
    belt.style.animation='stripe-fast .9s linear infinite';
    drumShade.style.animation='stripe-fast .9s linear infinite';
    await sleep(560); await dispense('red'); SE.fan2(); confettiMid();
  }else if(p==='P3'){      // 逆回転チラ見せ
    await sleep(620); SE.rev();
    belt.style.animation='stripe-rev .12s linear 1'; drumShade.style.animation='stripe-rev .12s linear 1';
    await sleep(160);
    belt.style.animation='stripe-move 1.18s linear infinite'; drumShade.style.animation='stripe-move 1.18s linear infinite';
    await sleep(220); await dispense(''); SE.pop();
  }else if(p==='P4'){      // 通常
    await sleep(640); await dispense('green'); SE.pop();
  }else{                   // P5
    await sleep(620); await dispense(''); SE.pop();
  }
}

/* 排出口から“出て割れる” */
async function dispense(color=''){
  // フタ開
  lid.style.transform='rotateX(88deg)';
  flash.classList.add('on'); setTimeout(()=>flash.classList.remove('on'),140);

  // カプセル色
  capTop.className='cap capTop' + (color==='gold'?' gold':color==='green'?' green':color==='red'?' red':'');
  capBot.className='cap capBot' + (color==='gold'?' gold':color==='green'?' green':color==='red'?' red':'');
  capWrap.className='capWrap show';
  await sleep(520);

  // ぱかっ
  capWrap.classList.add('open');

  // フタ戻す
  setTimeout(()=>lid.style.transform='rotateX(0deg)',160);
}

/* 紙吹雪 */
function confettiMid(){ confetti({particleCount:220, spread:70, origin:{y:0.3}}); }
function confettiMax(){
  confetti({particleCount:360, spread:80, startVelocity:55, ticks:200, origin:{y:0.3}, colors:['#fff6cc','#f6e7ad','#d7c48a','#a78bff']});
  setTimeout(()=>confetti({particleCount:200, spread:72, origin:{y:0.3}}),160);
}

/* 結果表示（フルスクリーン） */
function showResult(p){
  const title = {P1:'🎉 1等', P2:'✨ 2等', P3:'😊 3等', P4:'👍 4等', P5:'🙂 5等'}[p];
  const prize = {P1:'MOËTシルバー', P2:'カフェパリ', P3:'焼酎ボトル', P4:'ドリンク1杯 or テキーラ', P5:'おつまみセット'}[p];

  // カード色
  rcard.className='rcard ' + (p==='P1'?'r1':p==='P2'?'r2':p==='P3'?'r3':p==='P4'?'r4':'r5');
  rt.textContent=title; rp.textContent=prize;
  resultLayer.style.display='grid';

  // チュッと表示される賞カード（カプセル内）
  ticket.className='ticket ' + (p==='P1'?'t1':p==='P2'?'t2':p==='P3'?'t3':p==='P4'?'t4':'t5');
  ticket.textContent = `${title} – ${prize}`;

  statusEl.textContent=title; detailEl.textContent=prize;
  lockBtn.style.display='inline-block';
}
</script>
</body>
</html>
