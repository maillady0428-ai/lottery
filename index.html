<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#0a0b18" />
<title>NEON CAPSULE – Looster Gacha</title>
<style>
  :root{
    --bg:#0a0b18; --bg2:#0b0c20;
    --panel:#111229; --edge:#2a2d6b;
    --txt:#eaf1ff; --muted:#93a0c9;
    --neo1:#6d7cff; --neo2:#00e7ff; --neo3:#b56dff;
    --good:#2df1a1; --warn:#ffd166; --hot:#ff6e9a;
  }
  *{box-sizing:border-box}
  body{
    margin:0; color:var(--txt);
    font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
    background:
      radial-gradient(1200px 600px at 80% -10%, #1623a840, transparent 60%),
      radial-gradient(1000px 700px at -10% 120%, #00e7ff22, transparent 65%),
      var(--bg);
  }

  /* ====== シェル ====== */
  .wrap{min-height:100svh; display:grid; place-items:center; padding:24px}
  .card{
    width:min(860px,96vw);
    background:linear-gradient(180deg, #1a1c40c2, #131534cc), var(--panel);
    border:1px solid var(--edge);
    border-radius:20px;
    padding:18px;
    box-shadow:0 10px 40px rgba(0,0,0,.6), inset 0 1px 0 #3940a033;
    position:relative; overflow:hidden;
  }
  .head{display:flex; align-items:center; justify-content:space-between; gap:12px}
  .brand{
    font-weight:900; letter-spacing:.04em; margin:0;
    font-size:20px;
    background:linear-gradient(90deg, var(--neo2), var(--neo1) 40%, var(--neo3));
    -webkit-background-clip:text; background-clip:text; color:transparent;
  }
  .sub{color:var(--muted); font-size:12px}

  /* ====== マシン（ネオンリング） ====== */
  .stage{
    margin-top:14px; border:1px solid #2a2d6b; border-radius:16px; padding:22px;
    background:linear-gradient(180deg, #0c0d24, #0b0c20);
    box-shadow: inset 0 0 24px #000a;
  }
  .wheel{
    width: min(560px, 88vw); aspect-ratio:1/1; margin:0 auto; position:relative;
    border-radius:50%;
    background:
      radial-gradient(closest-side, #0c0e2a 64%, transparent 65%),
      conic-gradient(from 0deg, #6d7cff33, #00e7ff22, #b56dff33, #6d7cff33);
    box-shadow: 0 0 40px #6d7cff33, inset 0 0 40px #00e7ff22;
  }
  .ring{
    position:absolute; inset:5%; border-radius:50%;
    border:8px solid transparent;
    border-top-color:#6d7cff; border-right-color:#00e7ff; border-left-color:#b56dff;
    filter:drop-shadow(0 0 12px #6d7cff88) drop-shadow(0 0 22px #00e7ff66);
    animation:spin 5.5s linear infinite;
  }
  .ring.fast{ animation:spin 1.2s linear infinite }
  .ring.reverse{ animation:spin-rev 0.16s linear 1 }
  @keyframes spin{to{transform:rotate(360deg)}}
  @keyframes spin-rev{from{transform:rotate(0)} to{transform:rotate(-90deg)}}

  /* カプセル（中央生成→落下→開封） */
  .capsule{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%) scale(.9);
    width:min(180px,28vw); height:min(180px,28vw);
    filter:drop-shadow(0 0 14px #00e7ff55);
    display:none;
  }
  .cap{position:absolute; inset:0; border-radius:50%;
    background: radial-gradient(circle at 35% 30%, #fff8, transparent 35%),
                linear-gradient(180deg, #6d7cff, #00d6ff);
    border:2px solid #8bd7ff55;
  }
  .capsule.gold .cap{ background:radial-gradient(circle at 35% 30%, #fff8, transparent 35%), linear-gradient(180deg,#ffd36a,#ffb300); border-color:#ffd36a77; filter:drop-shadow(0 0 18px #ffd36a66) }
  .capsule.green .cap{ background:radial-gradient(circle at 35% 30%, #fff8, transparent 35%), linear-gradient(180deg,#53f5a0,#06c67f) }
  .capsule.red   .cap{ background:radial-gradient(circle at 35% 30%, #fff8, transparent 35%), linear-gradient(180deg,#ff7aa3,#ff4e78) }

  .capTop{clip-path:inset(0 0 50% 0); transform-origin:50% 45%}
  .capBot{clip-path:inset(50% 0 0 0); transform-origin:50% 55%}
  .capsule.show{display:block; animation:popIn .22s ease}
  @keyframes popIn{from{transform:translate(-50%,-50%) scale(.6); opacity:.6} to{transform:translate(-50%,-50%) scale(.9); opacity:1}}

  .capOpen .capTop{ animation:topOpen .28s ease forwards }
  .capOpen .capBot{ animation:botOpen .28s ease forwards }
  @keyframes topOpen { to{ transform:translate(-8%,-22%) rotate(-18deg) } }
  @keyframes botOpen { to{ transform:translate(8%,22%) rotate(18deg) } }

  /* 稲妻 / 光柱 */
  .bolt, .pillar{position:absolute; inset:0; pointer-events:none; display:none}
  .bolt.show{display:block; background:
    repeating-linear-gradient(120deg, transparent 0 46px, #fff2 46px 47px),
    radial-gradient(500px 200px at 50% 45%, #fff3, transparent 65%)}
  .pillar.show{display:block; background:
    radial-gradient(circle, #ffd36a55 0 22%, transparent 24%),
    linear-gradient(180deg, transparent, #ffd36a99 40%, #fff 50%, #ffd36a99 60%, transparent);
    filter:blur(0.5px)}

  /* 操作部 */
  .panel{margin-top:14px; padding:14px; border:1px solid #27308f; border-radius:14px; background:#0c0e2a}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .btn{
    cursor:pointer; user-select:none; border:0; border-radius:12px;
    padding:12px 18px; font-weight:900; letter-spacing:.02em;
    color:#06101a; background:linear-gradient(180deg, #7df2ff, #49d4ff);
    box-shadow:0 6px 16px #00e7ff33, inset 0 1px 0 #fff9;
  }
  .btn:active{transform:translateY(1px)}
  .ghost{background:#101338; color:#cbd4ff; border:1px solid #2a3088}
  .result{font-size:18px}
  .muted{color:var(--muted)}

  /* 全画面リザルトカード */
  .resultLayer{
    position:fixed; inset:0; display:none; place-items:center; z-index:50;
    background:linear-gradient(180deg, #0a0b1890, #0a0b18f0);
    backdrop-filter: blur(2px);
  }
  .resultCard{
    width:min(640px,92vw); border-radius:18px; padding:20px;
    text-align:center; font-weight:900; letter-spacing:.02em;
    border:1px solid #2a2d6b;
    box-shadow:0 20px 60px #0009;
  }
  .r1{ background:linear-gradient(180deg,#fff8cc,#ffd36a); color:#5a4100 }
  .r2{ background:linear-gradient(180deg,#ffd6ea,#ff9cc0); color:#4a1230 }
  .r3{ background:linear-gradient(180deg,#e7d7ff,#bfa2ff); color:#2a1552 }
  .r4{ background:linear-gradient(180deg,#d6ffe9,#9cfad2); color:#0e4a2d }
  .r5{ background:linear-gradient(180deg,#e9eef9,#cbd6ff); color:#1a2c5a }
  .rTitle{font-size:28px; margin:0 0 6px}
  .rPrize{font-size:18px; opacity:.85; margin:0 0 12px}
  .rRow{display:flex; gap:10px; justify-content:center}
  .small{font-size:12px; color:#9bb1ff; margin-top:12px}

  /* STAFF & モーダル & ローディング */
  .staff{position:fixed; right:14px; bottom:14px; z-index:60}
  .modal{position:fixed; inset:0; display:none; place-items:center; background:#0009; z-index:70}
  .modal.open{display:grid}
  .dialog{width:min(420px,92vw); background:#0e1130; border:1px solid #2a2d6b; border-radius:14px; padding:16px}
  .input{width:100%; font-size:18px; padding:10px 12px; border-radius:10px; border:1px solid #2a2d6b; background:#0b0e29; color:#fff}
  .rowR{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}
  .overlay{position:fixed; inset:0; display:none; place-items:center; background:#00000066; z-index:40}
  .overlay.show{display:grid}
  .spinner{width:26px;height:26px;border:3px solid #2a2d6b;border-top-color:#7df2ff;border-radius:50%;animation:spin .9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="head">
      <div>
        <h1 class="brand">NEON CAPSULE</h1>
        <div class="sub">1 PLAY 500円 / STAFF解除 → START</div>
      </div>
      <button class="btn ghost" id="lockBtn" style="display:none">終了してロック</button>
    </div>

    <div class="stage">
      <div class="wheel">
        <div class="ring" id="ring"></div>
        <div class="bolt" id="bolt"></div>
        <div class="pillar" id="pillar"></div>

        <!-- カプセル（中央に出現して割れる） -->
        <div class="capsule" id="caps">
          <div class="cap capTop"></div>
          <div class="cap capBot"></div>
        </div>
      </div>
    </div>

    <div class="panel" id="lockPanel">
      <div class="result">🔒 ロック中。<span class="muted">店員に解除を依頼してください。</span></div>
      <div class="small">右下「STAFF」→ コード入力で解除（デフォルト: <code>loo500</code>）。</div>
    </div>

    <div class="panel" id="drawPanel" style="display:none">
      <div class="result" id="status">READY</div>
      <div class="muted" id="detail">「START」で抽選します。</div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="startBtn">START</button>
      </div>
    </div>

    <div class="small" style="opacity:.8; margin-top:10px">
      景品：1等 MOËTシルバー / 2等 カフェパリ / 3等 焼酎ボトル / 4等 ドリンク1杯 or テキーラ / 5等 おつまみセット
    </div>
  </div>
</div>

<!-- 結果レイヤ -->
<div class="resultLayer" id="resultLayer" aria-hidden="true">
  <div class="resultCard r5" id="resultCard">
    <h2 class="rTitle" id="rTitle">5等</h2>
    <p class="rPrize" id="rPrize">おつまみセット</p>
    <div class="rRow">
      <button class="btn" id="againBtn">OK</button>
    </div>
    <div class="small">スタッフの操作で終了ロックしてください。</div>
  </div>
</div>

<!-- STAFF -->
<div class="staff">
  <button class="btn" id="staffBtn">STAFF</button>
</div>
<div class="modal" id="codeModal">
  <div class="dialog">
    <h3 style="margin:0 0 10px">解除コード</h3>
    <input id="codeInput" class="input" type="password" placeholder="loo500" />
    <div class="rowR">
      <button class="btn ghost" id="cancelBtn">キャンセル</button>
      <button class="btn" id="unlockBtn">解除</button>
    </div>
  </div>
</div>

<div class="overlay" id="overlay"><div class="spinner"></div></div>

<script>
/* ====== 設定 ====== */
const GAS = "https://script.google.com/macros/s/AKfycbx2kXtpfhtmof_YWD5FEOJVvN03zdnD4yXNysO32DmNcTkXZSEJknF8Wn2mayqlUFFVgg/exec";
const STAFF_CODE = "loo500";

/* ====== 要素 ====== */
const ring=document.getElementById('ring');
const caps=document.getElementById('caps');
const bolt=document.getElementById('bolt');
const pillar=document.getElementById('pillar');

const lockPanel=document.getElementById('lockPanel');
const drawPanel=document.getElementById('drawPanel');
const startBtn=document.getElementById('startBtn');
const lockBtn=document.getElementById('lockBtn');
const statusEl=document.getElementById('status');
const detailEl=document.getElementById('detail');

const resultLayer=document.getElementById('resultLayer');
const resultCard=document.getElementById('resultCard');
const rTitle=document.getElementById('rTitle');
const rPrize=document.getElementById('rPrize');
const againBtn=document.getElementById('againBtn');

const staffBtn=document.getElementById('staffBtn');
const codeModal=document.getElementById('codeModal');
const codeInput=document.getElementById('codeInput');
const cancelBtn=document.getElementById('cancelBtn');
const unlockBtn=document.getElementById('unlockBtn');

const overlay=document.getElementById('overlay');

/* ====== 音（簡易WebAudio） ====== */
let ctx=null;
function audio(){ if(!ctx) ctx=new (window.AudioContext||window.webkitAudioContext)(); }
function tone(f,d=.10,t='square',g=.06){ if(!ctx) return; const o=ctx.createOscillator(), v=ctx.createGain();
  o.type=t; o.frequency.value=f; v.gain.value=g; o.connect(v); v.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+d); }
const SE={
  lever:()=>{ tone(220,.07,'sawtooth',.08); setTimeout(()=>tone(160,.06,'square',.06),70) },
  spin :()=>{ if(!ctx) return; const o=ctx.createOscillator(), v=ctx.createGain(); o.type='triangle';
              o.frequency.setValueAtTime(90,ctx.currentTime); v.gain.setValueAtTime(.016,ctx.currentTime);
              o.connect(v); v.connect(ctx.destination); o.start();
              setTimeout(()=>{v.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+.12); o.stop(ctx.currentTime+.14)},360) },
  rev  :()=>{ tone(520,.06,'sawtooth',.06); setTimeout(()=>tone(380,.08,'triangle',.05),60) },
  fan2 :()=>{ tone(784,.12); setTimeout(()=>tone(988,.18),120) },
  fan1 :()=>{ tone(784,.12); setTimeout(()=>tone(988,.14),120); setTimeout(()=>tone(1175,.20),260) }
};

/* ====== ロック制御 ====== */
function setLocked(lock=true){
  lockPanel.style.display = lock ? '' : 'none';
  drawPanel.style.display = lock ? 'none' : '';
  lockBtn.style.display   = lock ? 'none' : 'inline-block';
  if(lock){
    startBtn.disabled=false;
    statusEl.textContent='READY';
    detailEl.textContent='「START」で抽選します。';
    resetFX();
  }
}
setLocked(true);

/* ====== STAFF ====== */
function openCode(){ codeModal.classList.add('open'); codeInput.value=''; codeInput.focus(); }
function closeCode(){ codeModal.classList.remove('open'); }
staffBtn.addEventListener('click', openCode);
cancelBtn.addEventListener('click', closeCode);
unlockBtn.addEventListener('click', ()=>{
  if((codeInput.value||'').trim()===STAFF_CODE){ setLocked(false); closeCode(); }
  else{ codeInput.value=''; codeInput.placeholder='コードが違います'; codeInput.focus(); }
});

/* ====== FX ====== */
function resetFX(){
  ring.classList.remove('fast','reverse');
  caps.className='capsule'; caps.style.display='none';
  bolt.classList.remove('show'); pillar.classList.remove('show');
}
function showCaps(color){
  caps.className='capsule '+(color||'');
  caps.style.display='block';
}
function openCaps(){ caps.classList.add('capOpen'); }

/* ====== 抽選 ====== */
startBtn.addEventListener('click', draw);
lockBtn.addEventListener('click', ()=>setLocked(true));
againBtn.addEventListener('click', ()=>{ resultLayer.style.display='none'; });

function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

async function draw(){
  startBtn.disabled=true; audio(); SE.lever();

  // 見た目スピン
  resetFX(); ring.classList.add('fast'); SE.spin();

  // 抽選
  overlay.classList.add('show');
  let data=null;
  try{
    const res = await fetch(GAS+'?ua='+encodeURIComponent(navigator.userAgent), {cache:'no-store'});
    data = await res.json();
  }catch(e){}
  overlay.classList.remove('show');

  if(!data || !data.status){ statusEl.textContent='通信エラー。もう一度。'; startBtn.disabled=false; return; }

  // 等級演出
  if(data.status==='ok'){ await play(data.prize); showResult(data.prize); }
  else { await play('P5'); showResult('P5'); }

  startBtn.disabled=false;
}

async function play(p){
  if(p==='P1'){ // 金光柱→生成→開封→紙吹雪MAX
    await sleep(500);
    pillar.classList.add('show'); await sleep(220);
    showCaps('gold'); await sleep(260);
    openCaps(); SE.fan1();
    confettiMax();
  }else if(p==='P2'){ // 稲妻→生成→開封
    bolt.classList.add('show'); await sleep(520);
    showCaps('red'); await sleep(240);
    openCaps(); SE.fan2(); confettiMid();
  }else if(p==='P3'){ // 逆回転パルス→生成→開封
    SE.rev(); ring.classList.add('reverse'); await sleep(160);
    ring.classList.remove('reverse'); await sleep(260);
    showCaps(''); await sleep(220);
    openCaps();
  }else if(p==='P4'){
    await sleep(520); showCaps('green'); await sleep(240); openCaps();
  }else{ // P5
    await sleep(480); showCaps(''); await sleep(220); openCaps();
  }
}

/* ====== 紙吹雪 ====== */
function confettiMid(){ confetti({particleCount:220, spread:70, origin:{y:0.3}}); }
function confettiMax(){
  confetti({particleCount:340, spread:80, startVelocity:55, origin:{y:0.3}, ticks:200,
            colors:['#fff6cc','#ffd36a','#7df2ff','#b56dff']});
  setTimeout(()=>confetti({particleCount:220, spread:72, origin:{y:0.3}}),160);
}

/* ====== 結果表示（フルスクリーンカード） ====== */
function showResult(p){
  const title = {P1:'🎉 1等', P2:'✨ 2等', P3:'😊 3等', P4:'👍 4等', P5:'🙂 5等'}[p];
  const prize = {P1:'MOËTシルバー', P2:'カフェパリ', P3:'焼酎ボトル', P4:'ドリンク1杯 or テキーラ', P5:'おつまみセット'}[p];

  rTitle.textContent = title;
  rPrize.textContent = prize;

  resultCard.className = 'resultCard ' + (
    p==='P1'?'r1':p==='P2'?'r2':p==='P3'?'r3':p==='P4'?'r4':'r5'
  );
  resultLayer.style.display='grid';

  statusEl.textContent = title;
  detailEl.textContent = prize;
}
</script>
</body>
</html>
